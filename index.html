<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Shared Watchlist</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark theme background */
            color: #c9d1d9;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-white mb-2 tracking-tight">Our Watchlist</h1>
            <p class="text-lg text-gray-400">Movies & Shows to watch together.</p>
        </header>

        <!-- Search and Add Section -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-10">
            <h2 class="text-2xl font-semibold mb-4 text-white">Add New Item</h2>
            
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="omdb-search-input" placeholder="Search for a Movie or Show Title..."
                       class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-sky-500 focus:border-sky-500 border-none transition duration-150 ease-in-out">
                <button onclick="handleSearch()"
                        class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.01] flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    Search
                </button>
            </div>

            <!-- OMDB Search Results and Details Display -->
            <div id="omdb-results" class="hidden mt-4 bg-gray-700 p-4 rounded-lg border border-gray-600">
                <div id="search-feedback" class="text-center text-gray-400 py-4 hidden"></div>

                <div id="omdb-detail-card" class="flex flex-col md:flex-row items-start gap-4">
                    <!-- Image will be injected here -->
                    <img id="omdb-poster" src="" alt="Poster" class="w-24 h-36 object-cover rounded-lg shadow-lg flex-shrink-0">
                    <div class="flex-grow">
                        <h3 id="omdb-title" class="text-xl font-bold text-white"></h3>
                        <p id="omdb-meta" class="text-sm text-gray-400 mb-3"></p>
                        <p id="omdb-plot" class="text-gray-300 text-sm mb-4"></p>
                        <button onclick="addItemToWatchlist()"
                                class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ease-in-out transform hover:scale-[1.01]">
                            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add to Watchlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Watchlist Display Section -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-semibold mb-6 text-white">Our Current Watchlist</h2>
            <div id="loading-indicator" class="text-center text-gray-500 py-8 text-lg hidden">
                Loading list...
            </div>
            <div id="watchlist-container" class="space-y-4">
                <!-- Watchlist items will be injected here -->
                <div class="text-center text-gray-500 py-8 hidden" id="empty-list-message">
                    The watchlist is empty! Time to add some new content.
                </div>
            </div>
        </div>

    </div>

    <script>
        // =========================================================================
        // 1. CONFIGURATION
        // =========================================================================

        // !!! IMPORTANT !!!
        // 1. REPLACE THIS PLACEHOLDER WITH YOUR DEPLOYED GOOGLE APPS SCRIPT URL
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyvfCy8oGsFGmjN2EDMS9Ij3NA3kYMdOz4NYdpyNHFndm5diu2PEl-KEU-bKNMk1cT4/exec';  // 2. REPLACE THIS PLACEHOLDER WITH YOUR ACTUAL OMDB API KEY
        const OMDB_API_KEY = '379bafb0'; 

        const apiUrl = `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&r=json`;

        // =========================================================================
        // 2. STATE MANAGEMENT & DOM REFERENCES
        // =========================================================================

        let currentOMDBResult = null; // Stores the currently selected item from OMDB search
        
        const watchlistContainer = document.getElementById('watchlist-container');
        const omdbResultsDiv = document.getElementById('omdb-results');
        const searchFeedback = document.getElementById('search-feedback');
        const omdbDetailCard = document.getElementById('omdb-detail-card');
        const loadingIndicator = document.getElementById('loading-indicator');
        const emptyListMessage = document.getElementById('empty-list-message');
        const searchInput = document.getElementById('omdb-search-input');

        // =========================================================================
        // 3. GOOGLE APPS SCRIPT (GAS) CONNECTOR
        // =========================================================================

        /**
         * Sends a request to the deployed Google Apps Script (GAS) Web App.
         * @param {string} action - The action to perform (e.g., 'GET_LIST', 'ADD_ITEM').
         * @param {Object} data - The data payload.
         */
        async function makeGasRequest(action, data = {}) {
            loadingIndicator.classList.remove('hidden');

            try {
                // The GAS endpoint is expecting a JSON payload which is a common setup.
                // The Content-Type header is often omitted for GAS, but we'll include
                // the data stringified as the body payload.
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    // The body content is typically sent as an object containing the action and data
                    body: JSON.stringify({ action, ...data }) 
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                // GAS returns a JSON object with { success: bool, data: array/object, error: string }
                const result = await response.json();
                return result;

            } catch (error) {
                console.error('Error contacting Google Apps Script:', error);
                // Fallback for errors
                return { success: false, error: 'Failed to communicate with the Google Sheets backend.' };
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }


        // =========================================================================
        // 4. OMDB API LOGIC
        // =========================================================================

        /**
         * Fetches movie/show details from the OMDB API.
         * @param {string} title 
         */
        async function searchOMDB(title) {
            searchFeedback.classList.add('hidden');
            omdbDetailCard.classList.add('hidden');
            
            if (!OMDB_API_KEY || OMDB_API_KEY === 'YOUR_OMDB_API_KEY') {
                searchFeedback.textContent = "Error: Please set your OMDB_API_KEY in the script.";
                searchFeedback.classList.remove('hidden');
                return null;
            }

            try {
                searchFeedback.textContent = "Searching OMDB...";
                searchFeedback.classList.remove('hidden');

                // Exponential backoff setup for fetch retry (up to 3 times)
                let data = null;
                for (let i = 0; i < 3; i++) {
                    const response = await fetch(`${apiUrl}&t=${encodeURIComponent(title)}&plot=short`);
                    if (response.ok) {
                        data = await response.json();
                        break;
                    }
                    if (i < 2) {
                         await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); // 1s, 2s delay
                    } else {
                        throw new Error('Failed to fetch OMDB data after multiple retries.');
                    }
                }
                
                searchFeedback.classList.add('hidden');

                if (data.Response === "True") {
                    currentOMDBResult = data;
                    renderOMDBResult(data);
                    return data;
                } else {
                    currentOMDBResult = null;
                    searchFeedback.textContent = `Could not find "${title}". Please try a different title.`;
                    searchFeedback.classList.remove('hidden');
                    omdbResultsDiv.classList.remove('hidden');
                    omdbDetailCard.classList.add('hidden');
                    return null;
                }
            } catch (error) {
                console.error("OMDB Search Error:", error);
                searchFeedback.textContent = "An error occurred during search. Check console.";
                searchFeedback.classList.remove('hidden');
                return null;
            }
        }

        /**
         * Renders the fetched OMDB data into the detail card.
         * @param {Object} data - OMDB response object.
         */
        function renderOMDBResult(data) {
            document.getElementById('omdb-title').textContent = data.Title;
            document.getElementById('omdb-meta').textContent = `${data.Type} | ${data.Year} | Rated: ${data.Rated}`;
            document.getElementById('omdb-plot').textContent = data.Plot;
            
            const posterEl = document.getElementById('omdb-poster');
            const posterUrl = data.Poster && data.Poster !== 'N/A' ? data.Poster : 'https://placehold.co/96x144/1f2937/d1d5db?text=No+Poster';
            
            posterEl.src = posterUrl;
            posterEl.onerror = () => {
                posterEl.src = 'https://placehold.co/96x144/1f2937/d1d5db?text=No+Poster';
            };

            omdbResultsDiv.classList.remove('hidden');
            omdbDetailCard.classList.remove('hidden');
        }

        function handleSearch() {
            const title = searchInput.value.trim();
            if (title) {
                searchOMDB(title);
            }
        }


        // =========================================================================
        // 5. WATCHLIST CRUD OPERATIONS (via GAS)
        // =========================================================================

        /**
         * Adds the currently displayed OMDB item to the Google Sheet via GAS.
         */
        async function addItemToWatchlist() {
            if (!currentOMDBResult) return;

            const itemData = {
                Type: currentOMDBResult.Type,
                Title: currentOMDBResult.Title,
                Year: currentOMDBResult.Year,
                PosterURL: currentOMDBResult.Poster && currentOMDBResult.Poster !== 'N/A' ? currentOMDBResult.Poster : '',
                IMDB_ID: currentOMDBResult.imdbID,
            };

            const response = await makeGasRequest('ADD_ITEM', itemData);
            
            if (response.success) {
                // Clear the input and hide the results card upon success
                searchInput.value = '';
                omdbResultsDiv.classList.add('hidden');
                omdbDetailCard.classList.add('hidden');
                currentOMDBResult = null;
                renderWatchlist(response.data);
            } else {
                console.error("Failed to add item:", response.error);
                // In a real app, you would show a custom modal error message here
            }
        }

        /**
         * Deletes an item from the sheet.
         * @param {string} id - Unique ID of the item (the row number).
         */
        async function deleteItem(id) {
            // WARNING: Due to environment restrictions, we cannot use window.confirm().
            // In a real app, implement a custom UI modal for confirmation.
            // For now, we proceed with deletion directly.
            console.warn(`Proceeding to delete item with ID: ${id}. Please implement a custom confirmation modal.`);

            const response = await makeGasRequest('DELETE_ITEM', { ID: id });
            
            if (response.success) {
                renderWatchlist(response.data);
            } else {
                console.error("Failed to delete item:", response.error);
            }
        }

        /**
         * Toggles the 'Watched' status of an item.
         * @param {string} id - Unique ID of the item.
         * @param {boolean} currentStatus - The current 'Watched' status.
         */
        async function toggleWatched(id, currentStatus) {
            const newStatus = !currentStatus;
            
            const response = await makeGasRequest('TOGGLE_WATCHED', { 
                ID: id, 
                WatchedStatus: newStatus 
            });

            if (response.success) {
                renderWatchlist(response.data);
            } else {
                console.error("Failed to update status:", response.error);
            }
        }
        
        // =========================================================================
        // 6. UI RENDERING
        // =========================================================================

        /**
         * Renders the main watchlist.
         * @param {Array<Object>} items - Array of watchlist objects from GAS.
         */
        function renderWatchlist(items) {
            watchlistContainer.innerHTML = '';
            
            if (!items || items.length === 0) {
                emptyListMessage.classList.remove('hidden');
                return;
            }
            emptyListMessage.classList.add('hidden');

            items.forEach(item => {
                // GAS will return boolean or string 'TRUE'/'FALSE'. Normalize to boolean.
                const isWatched = item.Watched === true || String(item.Watched).toUpperCase() === 'TRUE'; 

                const cardClasses = isWatched 
                    ? 'bg-gray-700 opacity-60 hover:opacity-100 transition duration-300' 
                    : 'bg-gray-700 ring-4 ring-sky-500/30 hover:ring-sky-500/50 transition duration-300';
                
                const titleClasses = isWatched ? 'line-through text-gray-400' : 'text-white';
                
                const posterUrl = item.PosterURL && item.PosterURL !== 'N/A' 
                    ? item.PosterURL 
                    : `https://placehold.co/80x120/1f2937/d1d5db?text=${item.Type ? item.Type[0] : '?'}`;

                const cardHtml = `
                    <div class="flex p-4 rounded-xl shadow-lg items-center ${cardClasses}">
                        <!-- Poster -->
                        <img src="${posterUrl}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/80x120/1f2937/d1d5db?text=NO+IMAGE';"
                             alt="${item.Title} Poster" class="w-16 h-24 sm:w-20 sm:h-30 object-cover rounded-lg mr-4 flex-shrink-0 shadow-md">
                        
                        <!-- Details -->
                        <div class="flex-grow min-w-0">
                            <h3 class="text-lg font-bold truncate ${titleClasses}">${item.Title} (${item.Year})</h3>
                            <p class="text-sm text-gray-400">
                                ${item.Type || 'Unknown'} | Added: ${item.Timestamp ? new Date(item.Timestamp).toLocaleDateString() : 'N/A'}
                            </p>
                        </div>

                        <!-- Actions (Flex container to keep buttons together) -->
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 ml-4 flex-shrink-0">
                            <!-- Toggle Watched Button -->
                            <button onclick="toggleWatched('${item.ID}', ${isWatched})" 
                                    title="${isWatched ? 'Mark as Unwatched' : 'Mark as Watched'}"
                                    class="${isWatched ? 'bg-amber-500 hover:bg-amber-600' : 'bg-emerald-600 hover:bg-emerald-700'} text-white p-2 rounded-full transition duration-150 transform hover:scale-105">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    ${isWatched 
                                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' // X icon (Unwatched)
                                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' // Check icon (Watched)
                                    }
                                </svg>
                            </button>

                            <!-- Delete Button -->
                            <button onclick="deleteItem('${item.ID}')" 
                                    title="Remove from Watchlist"
                                    class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full transition duration-150 transform hover:scale-105">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                watchlistContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // =========================================================================
        // 7. INITIALIZATION
        // =========================================================================

        /**
         * Loads the initial list when the page opens.
         */
        async function init() {
            // Pre-fill search with a common movie for quick testing
            searchInput.value = 'Inception';
            
            const response = await makeGasRequest('GET_LIST');
            if (response.success) {
                renderWatchlist(response.data);
            } else {
                console.error("Initialization failed:", response.error);
                loadingIndicator.textContent = `Failed to load list. Please check your GAS_URL and API Key. Details: ${response.error || 'Unknown Error'}`;
                loadingIndicator.classList.remove('hidden');
            }
        }

        window.onload = init;
        
    </script>
</body>
</html>
